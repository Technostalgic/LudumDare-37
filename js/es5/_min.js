"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},_createClass=function(){function o(n,u){for(var k,g=0;g<u.length;g++)k=u[g],k.enumerable=k.enumerable||!1,k.configurable=!0,"value"in k&&(k.writable=!0),Object.defineProperty(n,k.key,k)}return function(n,u,g){return u&&o(n.prototype,u),g&&o(n,g),n}}();function _classCallCheck(o,n){if(!(o instanceof n))throw new TypeError("Cannot call a class as a function")}window.addEventListener("keydown",function(o){-1<[32,37,38,39,40].indexOf(o.keyCode)&&o.preventDefault()},!1);var vec2=function(){function o(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,u=1<arguments.length&&void 0!==arguments[1]?arguments[1]:n;_classCallCheck(this,o),this.x=n,this.y=u}return _createClass(o,[{key:"normalized",value:function(){var u=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1;return this.multiply(u/this.distance())}},{key:"inverted",value:function(){return this.multiply(-1)}},{key:"multiply",value:function(u){return new o(this.x*u,this.y*u)}},{key:"plus",value:function(u){return new o(this.x+u.x,this.y+u.y)}},{key:"minus",value:function(u){return this.plus(u.inverted())}},{key:"equals",value:function(u){var g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;return Math.abs(this.x-u.x)<=g&&Math.abs(this.y-u.y)<=g}},{key:"direction",value:function(){return Math.atan2(this.y,this.x)}},{key:"distance",value:function(){var u=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;null===u&&(u=new o);var g=Math.sqrt(Math.pow(this.x-u.x,2)+Math.pow(this.y-u.y,2));return g}},{key:"toString",value:function(){return"vec2<"+this.x+","+this.y+">"}},{key:"copy",value:function(){return new o(this.x,this.y)}}],[{key:"fromAng",value:function(u){var g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;return new o(Math.cos(u)*g,Math.sin(u)*g)}},{key:"up",value:function(){return new o(0,-1)}},{key:"down",value:function(){return new o(0,1)}},{key:"left",value:function(){return new o(-1,0)}},{key:"right",value:function(){return new o(1,0)}}]),o}(),polygon=function(){function o(){_classCallCheck(this,o),this.parent=null,this._points=[],this._position=new vec2,this._scale=1,this._rotation=0,this._absVerts=[],this._boundingbox=new box,this._rays=null,this._hflip=!1}return _createClass(o,[{key:"getBoundingBox",value:function(){return this._boundingbox}},{key:"updateBoundingBox",value:function(){if(1>this._absVerts.length)return new box(this._position.x,this._position.y);for(var u=this._absVerts[0].x,g=this._absVerts[0].x,k=this._absVerts[0].y,_=this._absVerts[0].y,P=1;P<this._absVerts.length;P+=1)u=Math.min(u,this._absVerts[P].x),g=Math.max(g,this._absVerts[P].x),k=Math.min(k,this._absVerts[P].y),_=Math.max(_,this._absVerts[P].y);this._boundingbox=new box(u,k,g-u,_-k)}},{key:"getAbsoluteVertices",value:function(){return this._absVerts}},{key:"updateAbsVerts",value:function(){this._absVerts=[];for(var g,u=0;u<this._points.length;u+=1){g=this._points[u],this.getFlipped()&&(g.x*=-1);var k=g.direction(),_=g.distance();g=vec2.fromAng(k+this._rotation,_),g=g.multiply(this._scale),g=g.plus(this._position),this._absVerts.push(g)}this._rays=null,this.updateBoundingBox()}},{key:"setVerts",value:function(u){this._points=u,this.updateAbsVerts()}},{key:"getVerts",value:function(){return this._points}},{key:"move",value:function(u){return this._position=this._position.plus(u),this.updateAbsVerts(),this}},{key:"getFlipped",value:function(){return this._hflip}},{key:"setFlipped",value:function(){var u=0<arguments.length&&void 0!==arguments[0]?arguments[0]:!0;this._hflip=u,this.updateAbsVerts(),this.updateBoundingBox()}},{key:"setPosition",value:function(u){return this._position=u,this.updateAbsVerts(),this}},{key:"getPosition",value:function(){return this._position}},{key:"setScale",value:function(u){return this._scale=u,this.updateAbsVerts(),this}},{key:"getScale",value:function(){return this._scale}},{key:"setRotation",value:function(u){return this._rotation=u,this.updateAbsVerts(),this}},{key:"getRotation",value:function(){return this._rotation}},{key:"getEdgeRays",value:function(){return this._rays||ray.addPolygonRays(this),this._rays}},{key:"transform",value:function(u){for(var g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,k=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,_=0;_<this._points.length;_+=1){var P=this._points[_],V=P.direction(),C=P.distance();P=vec2.fromAng(V+g,C),P=P.multiply(k),P=P.plus(u),this._points[_]=P}this.updateAbsVerts()}},{key:"worldPointToLocal",value:function(u){var g=u;g=g.minus(this.getPosition()),g=g.multiply(1/this.getScale());var k=g.direction(),_=g.distance();return g=vec2.fromAng(k-this.getRotation(),_),g}},{key:"drawOutline",value:function(u){var g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"#888",k=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;if(!(2>this._absVerts.length)){u.strokeStyle=g,u.lineWidth=k,u.beginPath(),u.moveTo(this._absVerts[0].x,this._absVerts[0].y);for(var P,_=0;_<this._absVerts.length;_+=1)P=_+1,P>=this._absVerts.length&&(P=0),u.lineTo(this._absVerts[P].x,this._absVerts[P].y);u.stroke()}}},{key:"drawFill",value:function(u){var g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"#888";if(!(3>this._absVerts.length)){u.fillStyle=g,u.beginPath(),u.moveTo(this._absVerts[0].x,this._absVerts[0].y);for(var _,k=0;k<this._absVerts.length;k+=1)_=k+1,_>=this._absVerts.length&&(_=0),u.lineTo(this._absVerts[_].x,this._absVerts[_].y);u.fill()}}},{key:"toString",value:function(){return"polygon: "+this._points.toString()}}],[{key:"Rectangle",value:function(u){var g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:u,k=new o,_=[new vec2(u/-2,g/-2),new vec2(u/-2,g/2),new vec2(u/2,g/2),new vec2(u/2,g/-2)];return k.setVerts(_),k}},{key:"Circle",value:function(u){for(var g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:12,k=new o,_=[],P=0;P<g;P+=1){var V=P/g*(2*Math.PI),C=vec2.fromAng(V,u);_.push(C)}return k.setVerts(_),k}}]),o}(),box=function(){function o(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,u=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,g=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,k=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;_classCallCheck(this,o),this.position=new vec2(n,u),this.size=new vec2(g,k)}return _createClass(o,[{key:"top",value:function(){return this.position.y}},{key:"bottom",value:function(){return this.position.y+this.size.y}},{key:"left",value:function(){return this.position.x}},{key:"right",value:function(){return this.position.x+this.size.x}},{key:"centerAt",value:function(u){return this.position=u.minus(this.size.multiply(.5)),this}},{key:"drawOutline",value:function(u){var g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"#888",k=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2;u.strokeStyle=g,u.lineWidth=k,u.strokeRect(this.position.x,this.position.y,this.size.x,this.size.y)}},{key:"drawFill",value:function(u){var g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"#888";u.fillStyle=g,u.fillRect(this.position.x,this.position.y,this.size.x,this.size.y)}},{key:"containsPoint",value:function(u){return u.x>=this.position.x&&u.x<=this.right()&&u.y>=this.position.y&&u.y<=this.bottom()}},{key:"testIntersect",value:function(u){if(this.containsPoint(u.getPosition()))return!0;if(u._isVertical){var g=0<u._m?this.position.y:this.bottom();return u._origin.x>=this.position.x&&u._origin.x<=this.right()&&g<=u.length}var k=u.getEndPosition().x,_=Math.min(u._origin.x,k),P=Math.max(u._origin.x,k),V=u.getY(this.position.x);if(V>=this.position.y&&V<=this.bottom()&&_<=this.position.x&&this.position.x<=P)return!0;var C=u.getY(this.right());if(C>=this.position.y&&C<=this.bottom()&&_<=this.right()&&this.right()<=P)return!0;var S=u.getX(this.position.y);if(S>=this.position.x&&S<=this.right()&&_<=S&&S<=P)return!0;var R=u.getX(this.bottom());return R>=this.position.x&&R<=this.right()&&_<=R&&R<=P}},{key:"largestSideLength",value:function(){return Math.max(Math.abs(this.size.x),Math.abs(this.size.y))}},{key:"closestEdge",value:function(u){var g=new vec2(this.left(),this.top()),k=new vec2(this.right(),this.top()),_=new vec2(this.left(),this.bottom()),P=new vec2(this.right(),this.bottom()),V={d:u.distance(g),id:"tl"},C={d:u.distance(k),id:"tr"},S={d:u.distance(_),id:"bl"},R={d:u.distance(P),id:"br"},B=[V,C,S,R];return B.sort(function(T,z){return T.d-z.d}),B=[B[0].id,B[1].id],B.includes("tl")&&B.includes("tr")?"t":B.includes("tl")&&B.includes("bl")?"l":B.includes("tr")&&B.includes("br")?"r":B.includes("br")&&B.includes("bl")?"b":"n"}},{key:"toString",value:function(){return"box<l:"+this.left()+" r:"+this.right()+" t:"+this.top()+" b:"+this.bottom()+">"}}],[{key:"testOverlap",value:function(u,g){return!(g.left()>=u.right()||g.right()<=u.left()||g.top()>u.bottom()||g.bottom()<u.top())}},{key:"intersection",value:function(u,g){var k=Math.max(u.left(),g.left()),_=Math.min(u.right(),g.right()),P=Math.max(u.top(),g.top()),V=Math.min(u.bottom(),g.bottom());return new o(k,P,_-k,V-P)}},{key:"fromPoints",value:function(u,g){var k=Math.min(u.x,g.x),_=Math.max(u.x,g.x),P=Math.min(u.y,g.y),V=Math.max(u.y,g.y);return new o(k,P,_-k,V-P)}}]),o}(),ray=function(){function o(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:new vec2,u=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,g=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Infinity;_classCallCheck(this,o),this.length=g,this._parentPoly=null,this._origin=n,this._m=0,this._b=0,this._isVertical=!1,this._angle=0,this.setAngle(u)}return _createClass(o,[{key:"getPosition",value:function(){return this._origin}},{key:"setPosition",value:function(u){this._origin=u,this.recalculate()}},{key:"getEndPosition",value:function(){var u=this.length;return u==Infinity&&(u=999999),this._origin.plus(vec2.fromAng(this._angle).multiply(u))}},{key:"setEndPosition",value:function(u){var g=this._origin.distance(u),k=u.minus(this._origin).direction();this.length=g,this._angle=k,this.recalculate()}},{key:"getAngle",value:function(){return this.angle}},{key:"setAngle",value:function(u){Math.abs(u)>Math.PI&&(u=-1*(u%Math.PI)),u==-Math.PI&&(u=Math.PI),this._angle=u,this.recalculate()}},{key:"getSlope",value:function(){return this._isVertical?this._m*Infinity:this._m}},{key:"getOffsetY",value:function(){return this.isVertical?-1*this._m*Infinity:this._b}},{key:"getY",value:function(u){return this._isVertical?u>=this.origin.x?this._m*Infinity:this._m*-Infinity:this._m*u+this._b}},{key:"getX",value:function(u){return 0===this._m?this._origin.y:(u-this._b)/this._m}},{key:"recalculate",value:function(){1e-7>=Math.abs(Math.abs(this._angle)-Math.PI/2)?(this._m=Math.sign(this._angle),this._b=0,this._isVertical=!0):(this._m=Math.tan(this._angle),this._b=this._origin.y-this._m*this._origin.x,this._isVertical=!1)}},{key:"intersection",value:function(u){if(this._angle===u._angle||this.getPosition().distance(u.getPosition())>this.length+u.length)return null;var g=new vec2;if(this._isVertical){if(u._isVertical)return null;if(g.x=this._origin.x,g.y=u.getY(g.x),Math.sign(this._m)!=Math.sign(g.y-this._origin.y))return null;if(!u._isVertical){if(Math.sign(g.x-u._origin.x)!=(Math.abs(u._angle)<Math.PI/2?1:-1))return null;}else if(Math.sign(u._m)!=Math.sign(g.y-u._origin.y))return null;return g.distance(this._origin)>this.length?null:g.distance(u._origin)>u.length?null:g}return u._isVertical?u.intersection(this):(g.x=(u._b-this._b)/(this._m-u._m),g.y=this._m*g.x+this._b,g.distance(this._origin)>this.length?null:g.distance(u._origin)>u.length?null:Math.sign(g.x-this._origin.x)==(Math.abs(this._angle)<Math.PI/2?1:-1)?Math.sign(g.x-u._origin.x)==(Math.abs(u._angle)<Math.PI/2?1:-1)?g:null:null)}},{key:"draw",value:function(u){var g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"#f00",k=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;u.strokeStyle=g,u.lineWidth=k,u.beginPath(),u.moveTo(this.getPosition().x,this.getPosition().y);var _=this.getEndPosition();u.lineTo(_.x,_.y),u.stroke()}}],[{key:"rayData",value:function(u,g){var k=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Infinity,_=new o;return _._angle=null,_._m=u,_._b=g,_.length=k,_._origin=new vec2,_}},{key:"fromPoints",value:function(u,g){var k=g.minus(u).direction(),_=g.distance(u),P=new o(u,k,_);return P}}]),o}();var _createClass=function(){function o(n,u){for(var k,g=0;g<u.length;g++)k=u[g],k.enumerable=k.enumerable||!1,k.configurable=!0,"value"in k&&(k.writable=!0),Object.defineProperty(n,k.key,k)}return function(n,u,g){return u&&o(n.prototype,u),g&&o(n,g),n}}();function _classCallCheck(o,n){if(!(o instanceof n))throw new TypeError("Cannot call a class as a function")}var blocks=[],coins=[],block=function(){function o(n,u){_classCallCheck(this,o),this.col=new box(n-tilesize/2,u-tilesize/2,tilesize,tilesize),this.col.position=snapPoint(this.col.position,!1)}return _createClass(o,[{key:"draw",value:function(){this.col.drawFill(context,"#aaa"),this.col.drawOutline(context,"#555")}}]),o}(),coin=function(){function o(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:new vec2;_classCallCheck(this,o),this.pos=n,this.animOffset=10*Math.random()}return _createClass(o,[{key:"collect",value:function(){sfx_collect.play(),coins.splice(coins.indexOf(this),1),this._collectParticles(),score+=1,o.check();var u=getTotalAmmo();50>u?p1.ammo+=5:100>u?p1.ammo+=3:125>u&&(p1.ammo+=1)}},{key:"_collectParticles",value:function(){for(var g,u=20;0<u;u--)g=new seekerParticle(this.pos.x,this.pos.y,"#cc0",p1),g.setRandVel(10*Math.random()),particles.push(g)}},{key:"update",value:function(){this.pos.distance(p1.pos)<=tilesize&&this.collect()}},{key:"draw",value:function(){var u=(performance.now()/40+this.animOffset)%20-10,g=(performance.now()/40+10+this.animOffset)%20-10;u/=15,g/=15;var k=-1*tilesize*u+this.pos.x,_=tilesize*u+this.pos.x,P=-1*tilesize*g+this.pos.y,V=tilesize*g+this.pos.y;context.fillStyle="#ee0",context.strokeStyle="#550",context.beginPath(),context.arc(this.pos.x,this.pos.y,7,0,2*Math.PI),context.fill(),context.stroke(),context.fillStyle="#dd0",context.strokeStyle="#ff6",context.lineWidth=2,context.beginPath(),context.moveTo(k,this.pos.y),context.lineTo(this.pos.x,P),context.lineTo(_,this.pos.y),context.lineTo(this.pos.x,V),context.fill(),context.stroke()}}],[{key:"check",value:function(){0>=coins.length&&o.drop()}},{key:"drop",value:function(){for(var u=snapPoint(new vec2(playleft+Math.random()*(playright-playleft),playtop+Math.random()*(playbottom-playtop)));pointCollision(u)||100>=u.distance(p1.pos);)u=snapPoint(new vec2(playleft+Math.random()*(playright-playleft),playtop+Math.random()*(playbottom-playtop)));var g=new o(u);if(coins.push(g),0>=enemies.length&&enemies.push(enemy.firstEnemy()),0==score%6){for(var k=snapPoint(new vec2(playleft+Math.random()*(playright-playleft),playtop+Math.random()*(playbottom-playtop)));pointCollision(k)||100>=k.distance(p1.pos);)k=snapPoint(new vec2(playleft+Math.random()*(playright-playleft),playtop+Math.random()*(playbottom-playtop)));var _=new enemy;_.pos=k,enemies.push(_)}}}]),o}();function loadBlocks(){blocks=[];for(var o=0;5>o;o++)blocks.push(new block(30+o*tilesize,400));for(var o=0;5>o;o++)blocks.push(new block(540+o*tilesize,400));for(var o=0;7>o;o++)blocks.push(new block(260+o*tilesize,200))}function startcoin(){coins=[];var o=new coin(snapPoint(new vec2(width/2,100)));coins.push(o)}function updateCoins(){for(var o=0;o<coins.length;o++)coins[o].update()}function drawBlocks(){for(var o=0;o<blocks.length;o+=1)blocks[o].draw()}function drawCoins(){for(var o=0;o<coins.length;o++)coins[o].draw()}var _createClass=function(){function o(n,u){for(var k,g=0;g<u.length;g++)k=u[g],k.enumerable=k.enumerable||!1,k.configurable=!0,"value"in k&&(k.writable=!0),Object.defineProperty(n,k.key,k)}return function(n,u,g){return u&&o(n.prototype,u),g&&o(n,g),n}}();function _classCallCheck(o,n){if(!(o instanceof n))throw new TypeError("Cannot call a class as a function")}var enemies=[],p1,player=function(){function o(){_classCallCheck(this,o),this.pos=new vec2(width/2,500),this.vel=new vec2,this._col=new box(0,0,tilesize,tilesize),this.speed=3,this.canJump=!0,this.onCeil=!1,this.isbuilding=!1,this.lastbuiltUp=!1,this.aimDir=new vec2,this.ammo=10,this.attackdelay=20}return _createClass(o,[{key:"getCol",value:function(){return this._col.centerAt(this.pos)}},{key:"tilePos",value:function(){return snapPoint(this.pos)}},{key:"particleBurst",value:function(u){for(var k,g=35;0<g;g--)k=new seekerParticle(this.pos.x,this.pos.y,"#55d",u),k.setRandVel(35*Math.random()),particles.push(k)}},{key:"applyGravity",value:function(){this.vel.y+=gravity*dt,this.vel.y>10&&(this.vel.y=10)}},{key:"applyFriction",value:function(){this.vel.x*=(0.8-1)*dt+1}},{key:"checkCols",value:function(){this.canJump=!1,this.onCeil=!1,this.checkBounds(),this.checkBlocks()}},{key:"checkBounds",value:function(){var u=this.getCol();u.bottom()>=playbottom&&this.hitGround(playbottom),u.top()<playtop&&this.hitCeiling(playtop),u.left()<playleft&&this.hitLWall(playleft),u.right()>playright&&this.hitRWall(playright)}},{key:"checkBlocks",value:function(){for(var u=[],g=0;g<blocks.length;g+=1)box.testOverlap(this.getCol(),blocks[g].col)&&u.push(box.intersection(this.getCol(),blocks[g].col));this.collideOverlaps(u)}},{key:"collideOverlaps",value:function(u){if(!(0>=u.length))for(var g=this.getCol(),k=0;k<u.length;k+=1)2>u[k].largestSideLength()||(u[k].size.x>u[k].size.y?g.top()==u[k].top()?this.hitCeiling(u[k].bottom()):this.hitGround(u[k].top()):g.left()==u[k].left()?this.hitLWall(u[k].right()):this.hitRWall(u[k].left()))}},{key:"hitBox",value:function(u){switch(u.closestEdge(this.pos.minus(new vec2(this.vel.x,0)))){case"t":this.hitGround(u.top());break;case"l":this.hitRWall(u.left());break;case"r":this.hitLWall(u.right());break;case"b":this.hitCeiling(u.bottom());}}},{key:"hitGround",value:function(u){this.pos.y=u-this.getCol().size.y/2,5<Math.abs(this.vel.y)&&sfx_bump.play(),this.vel.y=0,this.canJump=!0}},{key:"hitCeiling",value:function(u){0<this.vel.y||(this.pos.y=u+this.getCol().size.y/2+.01,this.vel.y=0,this.onCeil=!0)}},{key:"hitLWall",value:function(u){this.pos.x=u+this.getCol().size.x/2,this.vel.x=0}},{key:"hitRWall",value:function(u){this.pos.x=u-this.getCol().size.x/2,this.vel.x=0}},{key:"control",value:function(){if(this.isbuilding){var u=10;return pressedControls.left?(this.buildLeft(),this.lastbuiltUp&&(this.vel.y=u,this.lastbuiltUp=!1)):pressedControls.right?(this.buildRight(),this.lastbuiltUp&&(this.vel.y=u,this.lastbuiltUp=!1)):pressedControls.up?this.buildUp():pressedControls.down?(this.buildDown(),this.lastbuiltUp=!1):this.lastbuiltUp?(this.vel.y=u,this.lastbuiltUp=!1):this.isbuilding=!1,pressedControls.jump&&this.jump(),void(pressedControls.build?this.build():this.isbuilding=!1)}pressedControls.left?this.moveLeft():pressedControls.right&&this.moveRight(),pressedControls.up?this.moveUp():pressedControls.down&&this.moveDown(),pressedControls.jump&&this.jump(),pressedControls.build&&this.build(),pressedControls.break&&this.break()}},{key:"moveLeft",value:function(){pointCollision(new vec2(this.pos.x-tilesize/2,this.pos.y))||(this.vel.x=-1*this.speed),this.aimDir=vec2.left()}},{key:"buildLeft",value:function(){if(this.canJump&&!(0>=this.ammo)){this.moveLeft();for(var u=snapPoint(this.pos.plus(new vec2(-0.4,1).multiply(tilesize))),g=this.tilePos().plus(vec2.left().multiply(tilesize/1.5)),k=blocks.length-1;0<=k;k--)blocks[k].col.containsPoint(g)&&breakBlock(blocks[k]);this.placeBlock(u)}}},{key:"moveRight",value:function(){pointCollision(new vec2(this.pos.x+tilesize/2,this.pos.y))||(this.vel.x=this.speed),this.aimDir=vec2.right()}},{key:"buildRight",value:function(){if(this.canJump&&!(0>=this.ammo)){this.moveRight();var u=snapPoint(this.pos.plus(new vec2(0.4,1).multiply(tilesize)));this.placeBlock(u);for(var g=this.tilePos().plus(vec2.right().multiply(tilesize/1.5)),k=blocks.length-1;0<=k;k--)blocks[k].col.containsPoint(g)&&breakBlock(blocks[k])}}},{key:"moveUp",value:function(){this.aimDir=vec2.up()}},{key:"buildUp",value:function(){if(this.moveUp(),!(0>=this.ammo)){this.lastbuiltUp=!0,this.moveUp(),this.vel.y=-1*this.speed,this.vel.x=0;for(var u=this.tilePos().plus(vec2.down().multiply(tilesize)),g=this.tilePos().plus(vec2.up().multiply(tilesize/1.5)),k=blocks.length-1;0<=k;k--)blocks[k].col.containsPoint(g)&&breakBlock(blocks[k]);this.placeBlock(u)}}},{key:"moveDown",value:function(){this.aimDir=vec2.down()}},{key:"buildDown",value:function(){if(this.moveDown(),!!this.canJump){this.pos=snapPoint(this.pos),this.vel=new vec2;for(var u=this.tilePos().plus(vec2.down().multiply(tilesize)),g=u.plus(vec2.down().multiply(tilesize)),k=blocks.length-1;0<=k;k--)blocks[k].col.containsPoint(u)&&breakBlock(blocks[k]);this.placeBlock(g)}}},{key:"jump",value:function(){if(this.canJump&&!this.onCeil){var u=this.getCol();if(u.position.y-=1,boxCollision(u))return;sfx_jump.play(),this._jumpParticles(),this.vel.y=-7,this.canJump=!1,this.isbuilding=!1}0>this.vel.y&&(this.vel.y-=0.5*(gravity*dt))}},{key:"_jumpParticles",value:function(){for(var k,u=this.getCol(),g=10;0<g;g-=1)k=new particle(u.position.x+Math.random()*u.size.x,u.bottom()),k.setRandVel(10*Math.random(),-Math.PI,0),k.vel=k.vel.minus(this.vel),k.add()}},{key:"build",value:function(){this.canJump&&(!this.isbuilding&&(this.vel.x=0),0.1>Math.abs(this.vel.x)&&(this.pos=snapPoint(this.pos).plus(this.pos).multiply(.5)),this.isbuilding=!0)}},{key:"break",value:function(){if(!(0<this.attackdelay||this.aimDir.equals(new vec2))){this._breakParticles(),this.attackdelay=20,sfx_attack.play();for(var u=this._getBreakBox(),g=blocks.length-1;0<=g;g--)box.testOverlap(blocks[g].col,u)&&breakBlock(blocks[g]);u=this._getSpitBox();for(var g=enemies.length-1;0<=g;g--)box.testOverlap(enemies[g].getCol(),u)&&(sfx_hitenemy.play(),enemies[g].vel=enemies[g].pos.minus(this.pos).normalized(10),enemies[g]._thinktimer=20*Math.random()+30,enemies[g].mov+=Math.random(Math.PI/2),enemies[g].seeking=!1,this.vel=this.aimDir.multiply(-this.speed),1==this.aimDir.y&&(this.vel.y-=2))}}},{key:"_getBreakBox",value:function(){var u=new box(0,0,tilesize/2,tilesize/2);return u.centerAt(this.pos.plus(this.aimDir.multiply(tilesize))),u}},{key:"_getSpitBox",value:function(){var u=new box(0,0,tilesize,tilesize);return 0!=this.aimDir.x&&(u.size.x=2*tilesize),0!=this.aimDir.y&&(u.size.y=2*tilesize),u.centerAt(this.pos.plus(this.aimDir.multiply(1.5*tilesize))),u}},{key:"_breakParticles",value:function(){for(var g,u=12;0<u;u--)g=new particle(this.pos.x,this.pos.y,"#00a"),g.vel=this.aimDir.multiply(5*Math.random()+3),g.vel=g.vel.plus(new vec2(3*(Math.random()-.5),3*(Math.random()-.5))),g.pos=g.pos.plus(g.vel.multiply(3)),particles.push(g)}},{key:"_blockBreakParticles",value:function(u){for(var P,g=new vec2(u.col.position.x+u.col.size.x/2,u.col.position.y+u.col.size.y/2),k=6,_=4;0<_;_--)P=new seekerParticle(g.x,g.y+Math.random()*tilesize-tilesize/2,"#333",p1),P.vel=new vec2(Math.random()*k,0),P.pos=P.pos.plus(P.vel.multiply(2)),particles.push(P),P.seekspeed=2;for(var P,_=4;0<_;_--)P=new seekerParticle(g.x,g.y+Math.random()*tilesize-tilesize/2,"#333",p1),P.vel=new vec2(Math.random()*-k,0),P.pos=P.pos.plus(P.vel.multiply(2)),particles.push(P),P.seekspeed=2;for(var P,_=4;0<_;_--)P=new seekerParticle(g.x+Math.random()*tilesize-tilesize/2,g.y,"#333",p1),P.vel=new vec2(0,Math.random()*k),P.pos=P.pos.plus(P.vel.multiply(2)),particles.push(P),P.seekspeed=2;for(var P,_=4;0<_;_--)P=new seekerParticle(g.x+Math.random()*tilesize-tilesize/2,g.y,"#333",p1),P.vel=new vec2(0,Math.random()*-k),P.pos=P.pos.plus(P.vel.multiply(2)),particles.push(P),P.seekspeed=2}},{key:"placeBlock",value:function(n){function u(){return n.apply(this,arguments)}return u.toString=function(){return n.toString()},u}(function(n){0>=this.ammo||placeBlock(n)})},{key:"update",value:function(){this.applyGravity(),this.applyFriction(),this.pos=this.pos.plus(this.vel.multiply(dt)),this.checkCols(),this.control(),this.attackdelay-=dt}},{key:"draw",value:function(){context.fillStyle="#aaf",context.strokeStyle="#337",context.lineWidth=2;var k=this.getCol();context.fillRect(k.position.x,k.position.y,k.size.x,k.size.y),context.strokeRect(k.position.x,k.position.y,k.size.x,k.size.y)}}]),o}(),enemy=function(){function o(){_classCallCheck(this,o),this.pos=new vec2,this.vel=new vec2,this.mov=0,this.speed=0.25,this.bounceFriction=1-Math.random()*Math.random(),this.airFrictionX=1-.2*Math.random(),this.airFrictionY=this.airFrictionX-.2*(Math.random()-.5),.99<=this.airFrictionY&&(this.airFrictionY=.98),.99<=this.airFrictionX&&(this.airFrictionX=.98),1.85<this.airFrictionY+this.airFrictionX&&(this.speed*=0.75-Math.random()/2),this._thinktimer=80,this.active=!1,this.seeking=!1}return _createClass(o,[{key:"canSeePlayer",value:function(){if(lostgame)return!1;for(var u=ray.fromPoints(this.pos,p1.pos),g=box.fromPoints(this.pos,p1.pos),k=[],_=0;_<blocks.length;_++)box.testOverlap(blocks[_].col,g)&&k.push(blocks[_]);for(var _=0;_<k.length;_++)if(k[_].col.testIntersect(u))return!1;return!0}},{key:"search",value:function(){this._thinktimer=20*Math.random()+30,this.canSeePlayer()?(this.seeking=!0,this._thinktimer*=4):(this.seeking=!1,this.mov+=Math.random(Math.PI/2))}},{key:"seek",value:function(){var u=p1.pos.minus(this.pos);u=u.normalized(this.speed),this.vel=this.vel.plus(u.multiply(dt))}},{key:"wander",value:function(){this.vel=this.vel.plus(vec2.fromAng(this.mov,this.speed*dt))}},{key:"getCol",value:function(){return new box(this.pos.x-tilesize/2,this.pos.y-tilesize/2,tilesize,tilesize)}},{key:"checkCols",value:function(){this.checkBounds(),this.checkBlocks()}},{key:"checkBounds",value:function(){var u=this.getCol();u.bottom()>=playbottom&&this.hitGround(playbottom),u.top()<playtop&&this.hitCeiling(playtop),u.left()<playleft&&this.hitLWall(playleft),u.right()>playright&&this.hitRWall(playright)}},{key:"checkBlocks",value:function(){for(var u=[],g=0;g<blocks.length;g+=1)box.testOverlap(this.getCol(),blocks[g].col)&&u.push(box.intersection(this.getCol(),blocks[g].col));this.collideOverlaps(u)}},{key:"collideOverlaps",value:function(u){if(!(0>=u.length))for(var g=this.getCol(),k=0;k<u.length;k+=1)2>u[k].largestSideLength()||(u[k].size.x>u[k].size.y?g.top()==u[k].top()?this.hitCeiling(u[k].bottom()):this.hitGround(u[k].top()):g.left()==u[k].left()?this.hitLWall(u[k].right()):this.hitRWall(u[k].left()))}},{key:"hitBox",value:function(u){switch(u.closestEdge(this.pos.minus(new vec2(this.vel.x,0)))){case"t":this.hitGround(u.top());break;case"l":this.hitRWall(u.left());break;case"r":this.hitLWall(u.right());break;case"b":this.hitCeiling(u.bottom());}}},{key:"hitGround",value:function(u){2<Math.abs(this.vel.y)&&sfx_enemybump.play(),this.pos.y=u-this.getCol().size.y/2,this.vel.y=-this.bounceFriction*Math.abs(this.vel.y),this.seeking||(this.mov=Math.PI/-2)}},{key:"hitCeiling",value:function(u){2<Math.abs(this.vel.y)&&sfx_enemybump.play(),this.pos.y=u+this.getCol().size.y/2,this.vel.y=this.bounceFriction*Math.abs(this.vel.y),this.seeking||(this.mov=Math.PI/2)}},{key:"hitLWall",value:function(u){2<Math.abs(this.vel.x)&&sfx_enemybump.play(),this.pos.x=u+this.getCol().size.x/2,this.vel.x=this.bounceFriction*Math.abs(this.vel.x),this.seeking||(this.mov=0)}},{key:"hitRWall",value:function(u){2<Math.abs(this.vel.x)&&sfx_enemybump.play(),this.pos.x=u-this.getCol().size.x/2,this.vel.x=-this.bounceFriction*Math.abs(this.vel.x),this.seeking||(this.mov=Math.PI)}},{key:"_spawnParticles",value:function(){if(!(Math.random()>dt)){var u=new seekerParticle(this.pos.x,this.pos.y,"#c00",this);u.setRandVel(3*Math.random()+3),u.pos=u.pos.plus(u.vel.multiply(Math.random()+1)),particles.push(u)}}},{key:"update",value:function(){return this.active?void(this.seeking?this.seek():this.wander(),this.vel.x*=this.airFrictionX,this.vel.y*=this.airFrictionY,this.pos=this.pos.plus(this.vel.multiply(dt)),this.checkCols(),!lostgame&&this.pos.distance(p1.pos)<tilesize&&(p1.particleBurst(this),losegame(),this.search()),this._thinktimer-=dt,0>=this._thinktimer&&this.search()):(this._thinktimer-=dt,this._spawnParticles(),void(0>=this._thinktimer&&(this.active=!0,this._thinktimer=0)))}},{key:"draw",value:function(){this.active&&(context.fillStyle="#faa",context.strokeStyle="#d33",context.lineWidth=2,context.beginPath(),context.arc(this.pos.x,this.pos.y,tilesize/2,0,2*Math.PI),context.fill(),context.stroke())}}],[{key:"firstEnemy",value:function(){var u=new o;return u.pos=new vec2(width/2,height/2+200),u.speed=0.15,u.bounceFriction=0.5,u.airFrictionX=0.93,u.airFrictionY=u.airFrictionX,u}}]),o}();function updateEnemies(){for(var o=0;o<enemies.length;o++)enemies[o].update()}function drawEnemies(){for(var o=0;o<enemies.length;o++)enemies[o].draw()}var _createClass=function(){function o(n,u){for(var k,g=0;g<u.length;g++)k=u[g],k.enumerable=k.enumerable||!1,k.configurable=!0,"value"in k&&(k.writable=!0),Object.defineProperty(n,k.key,k)}return function(n,u,g){return u&&o(n.prototype,u),g&&o(n,g),n}}();function _possibleConstructorReturn(o,n){if(!o)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n&&("object"===("undefined"==typeof n?"undefined":_typeof(n))||"function"==typeof n)?n:o}function _inherits(o,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof n?"undefined":_typeof(n)));o.prototype=Object.create(n&&n.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(o,n):o.__proto__=n)}function _classCallCheck(o,n){if(!(o instanceof n))throw new TypeError("Cannot call a class as a function")}var particles=[],particle=function(){function o(n,u){var g=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"#000";_classCallCheck(this,o),this.pos=new vec2(n,u),this.vel=new vec2,this.color=g}return _createClass(o,[{key:"setRandVel",value:function(u){var g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,k=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2*Math.PI,_=Math.random()*(k-g)+g;this.vel=vec2.fromAng(_,u)}},{key:"add",value:function(){particles.push(this)}},{key:"update",value:function(u){this.pos=this.pos.plus(this.vel.multiply(dt)),this.vel=this.vel.multiply(0.85),1>this.vel.distance()&&particles.splice(u,1)}},{key:"draw",value:function(){context.strokeStyle=this.color,context.lineWidth=2;var u=this.vel.multiply(dt);context.beginPath(),context.moveTo(this.pos.x-u.x,this.pos.y-u.y),context.lineTo(this.pos.x+u.x,this.pos.y+u.y),context.stroke()}}]),o}(),seekerParticle=function(o){function n(u,g,k){var _=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{pos:null};_classCallCheck(this,n);var P=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,u,g,k));return P.target=_,P.seekmode=!1,P.seekspeed=1,P}return _inherits(n,o),_createClass(n,[{key:"seek",value:function(){var g=this.target.pos.minus(this.pos);g=g.normalized(this.seekspeed),this.vel=this.vel.plus(g.multiply(dt))}},{key:"update",value:function(g){var k=.85;!this.seekmode&&1>this.vel.distance()&&(this.seekmode=!0),this.seekmode&&(this.seek(),this.pos.distance(this.target.pos)<tilesize&&particles.splice(g,1),k=.9),this.pos=this.pos.plus(this.vel.multiply(dt)),this.vel=this.vel.multiply(k)}}]),n}(particle);function updateParticles(){for(var o=0;o<particles.length;o+=1)particles[o].update(o)}function drawParticles(){for(var o=0;o<particles.length;o+=1)particles[o].draw()}var canvas=document.getElementById("canvas"),context=canvas.getContext("2d"),width=canvas.width,height=canvas.height,playtop=70,playleft=10,playright=width-10,playbottom=height-10,_lastTime=0,dt=0,highscorestorage="technonugget_ld37_highscore",introgame=!0,setcontrols=0,lostgame=!1,lostmessage="",score=0,hiscore=0,assignedcontrols={},pressedControls={},gravity=0.3,tilesize=20,sfx_attack=new Audio("audio/attack.wav"),sfx_breakblock=new Audio("audio/breakblock.wav"),sfx_bump=new Audio("audio/bump.wav"),sfx_collect=new Audio("audio/collect.wav"),sfx_enemybump=new Audio("audio/enemybump.wav"),sfx_hitenemy=new Audio("audio/hitenemy.wav"),sfx_jump=new Audio("audio/jump.wav"),sfx_lose=new Audio("audio/lose.wav"),sfx_placeblock=new Audio("audio/placeblock.wav");function clrCanvas(){context.fillStyle="#fff",context.fillRect(0,0,width,height)}function assignControls(){assignedcontrols={up:38,down:40,left:37,right:39,jump:90,build:88,break:67},pressedControls={up:!1,down:!1,left:!1,right:!1,jump:!1,build:!1,break:!1},document.addEventListener("keydown",keyDown),document.addEventListener("keyup",keyUp)}function keyDown(o){if(0<setcontrols)return void setControl(o.keyCode);switch(32==o.keyCode&&(lostgame||introgame)&&0>=setcontrols&&(saveHigh(),startgame()),o.keyCode){case 13:(lostgame||introgame)&&setControls_begin();break;case assignedcontrols.left:pressedControls.left=!0;break;case assignedcontrols.right:pressedControls.right=!0;break;case assignedcontrols.up:pressedControls.up=!0;break;case assignedcontrols.down:pressedControls.down=!0;break;case assignedcontrols.jump:pressedControls.jump=!0;break;case assignedcontrols.break:pressedControls.break=!0;break;case assignedcontrols.build:pressedControls.build=!0;}}function keyUp(o){switch(o.keyCode){case assignedcontrols.left:pressedControls.left=!1;break;case assignedcontrols.right:pressedControls.right=!1;break;case assignedcontrols.up:pressedControls.up=!1;break;case assignedcontrols.down:pressedControls.down=!1;break;case assignedcontrols.jump:pressedControls.jump=!1;break;case assignedcontrols.break:pressedControls.break=!1;break;case assignedcontrols.build:pressedControls.build=!1;}}function init(){console.clear(),loadHigh(),assignControls(),clrCanvas(),requestAnimationFrame(step),startgame(),introgame=!0}function step(){update(dt),requestAnimationFrame(step),dt=(performance.now()-_lastTime)/16.666,_lastTime=performance.now()}function update(o){return 2<o&&(dt=1,o=1),introgame?void draw():void(!lostgame&&p1.update(),updateEnemies(),updateCoins(),updateParticles(),draw())}function draw(){clrCanvas(),drawBlocks(),lostgame||p1.draw(),drawEnemies(),drawCoins(),drawParticles(),drawBorders(),drawHUD(),introgame&&drawIntroScreen(),lostgame&&drawLoseScreen()}function loadHigh(){var o=localStorage.getItem(highscorestorage);hiscore=o?parseInt(o):0}function saveHigh(){score>hiscore&&(hiscore=score),localStorage.setItem(highscorestorage,hiscore.toString())}function drawBorders(){context.fillStyle="#aaa",context.strokeStyle="#555",context.lineWidth=2,context.fillRect(0,0,width,playtop),context.fillRect(0,0,playleft,height),context.fillRect(playright,0,width-playleft,height),context.fillRect(0,playbottom,width,height-playbottom),context.strokeRect(playleft,playtop,playright-playleft,playbottom-playtop)}function drawHUD(){context.fillStyle="#000",context.font="28px sans-serif",context.textAlign="center",context.fillText("SCORE: "+score.toString(),width/2,40),context.font="12px sans-serif",context.textAlign="center",context.fillText("HI: "+hiscore.toString(),width/2,60),context.fillStyle="#888",context.strokeStyle="#222",context.lineWidth=4,context.fillRect(20,25,30,30),context.strokeRect(20,25,30,30),context.font="28px sans-serif",context.fillStyle="#000",context.textAlign="left",context.fillText("\xD7"+p1.ammo.toString(),60,50)}function drawLoseScreen(){return context.fillStyle="rgba(0,0,0,0.7)",context.fillRect(playleft,playtop,playright-playleft,playbottom-playtop),0<setcontrols?void drawControlScreen("#fff"):void(context.fillStyle="#fff",context.textAlign="center",context.font="48px sans-serif",context.fillText("GAME OVER",width/2,200),context.font="12px sans-serif",context.fillText("press the spacebar to lose again",width/2,220),context.font="24px sans-serif",context.fillText(lostmessage,width/2,320),context.font="12px sans-serif",context.fillText("press ENTER to set controls",width/2,height-12))}function drawIntroScreen(){return context.fillStyle="rgba(255,255,255,0.7)",context.fillRect(0,0,width,height),0<setcontrols?void drawControlScreen():void(context.fillStyle="#000",context.textAlign="center",context.font="bold 48px sans-serif",context.fillText("THE PIT",width/2,200),context.font="18px sans-serif",context.fillText("press space to begin",width/2,230),context.font="12px sans-serif",context.fillText("press ENTER to set controls",width/2,height-12))}function drawControlScreen(){var o=0<arguments.length&&arguments[0]!==void 0?arguments[0]:"#000";context.fillStyle=o,context.textAlign="center",context.font="bold 48px sans-serif",context.fillText("Press key for "+getControlName(),width/2,200)}function placeBlock(o){o=snapPoint(o);for(var n=0;n<enemies.length;n++)if(enemies[n].pos.distance(o)<=tilesize/2)return;if(!pointCollision(o)){sfx_placeblock.currentTime=0,sfx_placeblock.play();var u=new block(o.x,o.y);blocks.push(u),p1.ammo-=1}}function breakBlock(o){p1._blockBreakParticles(o),blocks.splice(blocks.indexOf(o),1),sfx_breakblock.currentTime=0,sfx_breakblock.play(),p1.ammo+=1,p1.vel=p1.vel.minus(p1.aimDir.multiply(p1.speed/2))}function pointCollision(o){if(o.x<=playleft)return!0;if(o.x>=playright)return!0;if(o.y<=playtop)return!0;if(o.y>=playbottom)return!0;for(var n=0;n<blocks.length;n+=1)if(blocks[n].col.containsPoint(o))return!0;return!1}function boxCollision(o){if(o.left()<playleft)return!0;if(o.right()>playright)return!0;if(o.top()<=playtop)return!0;if(o.bottom()>=playbottom)return!0;for(var n=0;n<blocks.length;n+=1)if(box.testOverlap(blocks[n].col,o))return!0;return!1}function snapPoint(o){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:!0,u=new vec2(playleft,playtop),g=o.minus(u).multiply(1/tilesize);return g=new vec2(Math.floor(g.x),Math.floor(g.y)),g=g.multiply(tilesize),n?g.plus(u).plus(new vec2(tilesize/2)):g.plus(u)}function getTotalAmmo(){return p1.ammo+blocks.length}function generateLoseMessage(){var o=["Sucks to suck.","Well then. That's that.","lol","Your family will miss you dearly","\xAF\\_(\u30C4)_/\xAF","You did good ( \u0361\xB0 \u035C\u0296 \u0361\xB0)","\u0CA0\u256D\u256E\u0CA0","(\u256F\xB0\u25A1\xB0\uFF09\u256F\uFE35 \u253B\u2501\u253B"];return o[Math.floor(Math.random()*o.length)]}function setControls_begin(){setcontrols=7}function setControl(o){7==setcontrols?assignedcontrols.right=o:6==setcontrols?assignedcontrols.left=o:5==setcontrols?assignedcontrols.up=o:4==setcontrols?assignedcontrols.down=o:3==setcontrols?assignedcontrols.break=o:2==setcontrols?assignedcontrols.build=o:1==setcontrols?assignedcontrols.jump=o:void 0;setcontrols--}function getControlName(){return 7==setcontrols?"'RIGHT'":6==setcontrols?"'LEFT'":5==setcontrols?"'UP'":4==setcontrols?"'DOWN'":3==setcontrols?"'ATTACK'":2==setcontrols?"'BUILD'":1==setcontrols?"'JUMP'":"???"}function startgame(){score=0,introgame=!1,lostgame=!1,p1=new player,enemies=[],startcoin(),particles=[],loadBlocks()}function losegame(){var o=0<arguments.length&&arguments[0]!==void 0?arguments[0]:generateLoseMessage();lostgame=!0,lostmessage=o,sfx_lose.play()}init();